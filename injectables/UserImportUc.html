<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>schulcloud-server documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">schulcloud-server documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li>Injectables</li>
  <li >UserImportUc</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>apps/server/src/modules/user-import/uc/user-import.uc.ts</code>
        </p>





            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#findAllImportUsers" >findAllImportUsers</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#findAllUnmatchedUsers" >findAllUnmatchedUsers</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#removeMatch" >removeMatch</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#saveAllUsersMatches" >saveAllUsersMatches</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#setMatch" >setMatch</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#updateFlag" >updateFlag</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Async</span>
                                <a href="#updateUserAndAccount" >updateUserAndAccount</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(accountRepo: <a href="../injectables/AccountRepo.html" target="_self">AccountRepo</a>, importUserRepo: <a href="../injectables/ImportUserRepo.html" target="_self">ImportUserRepo</a>, permissionService: <a href="../injectables/PermissionService.html" target="_self">PermissionService</a>, schoolRepo: <a href="../injectables/SchoolRepo.html" target="_self">SchoolRepo</a>, userRepo: <a href="../injectables/UserRepo.html" target="_self">UserRepo</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="21" class="link-to-prism">apps/server/src/modules/user-import/uc/user-import.uc.ts:21</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>accountRepo</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/AccountRepo.html" target="_self" >AccountRepo</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>importUserRepo</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/ImportUserRepo.html" target="_self" >ImportUserRepo</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>permissionService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/PermissionService.html" target="_self" >PermissionService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>schoolRepo</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/SchoolRepo.html" target="_self" >SchoolRepo</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>userRepo</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/UserRepo.html" target="_self" >UserRepo</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="findAllImportUsers"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>findAllImportUsers</b></span>
                        <a href="#findAllImportUsers"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>findAllImportUsers(userId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>, query: <a href="../interfaces/IImportUserScope.html" target="_self">IImportUserScope</a>, options?: IFindOptions<ImportUser>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="37"
                            class="link-to-prism">apps/server/src/modules/user-import/uc/user-import.uc.ts:37</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Resolves with current users schools importusers and matched users.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>userId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>query</td>
                                    <td>
                                                <code><a href="../interfaces/IImportUserScope.html" target="_self" >IImportUserScope</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>options</td>
                                    <td>
                                            <code>IFindOptions&lt;ImportUser&gt;</code>
                                    </td>

                                    <td>
                                        Yes
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../interfaces/User.html" target="_self" >Promise&lt;Counted&lt;ImportUser[]&gt;&gt;</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="findAllUnmatchedUsers"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>findAllUnmatchedUsers</b></span>
                        <a href="#findAllUnmatchedUsers"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>findAllUnmatchedUsers(currentUserId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>, query: <a href="../interfaces/INameMatch.html" target="_self">INameMatch</a>, options?: <a href="../entitys/User.html" target="_self">IFindOptions&lt;User&gt;</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="129"
                            class="link-to-prism">apps/server/src/modules/user-import/uc/user-import.uc.ts:129</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Returns a list of users wich is not assigned as match to importusers.
The result will filter by curernt users school by default.
The current user must have permission to read schools users and view importusers.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Description</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>currentUserId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                    <td>
                                    </td>
                                </tr>
                                <tr>
                                    <td>query</td>
                                    <td>
                                                <code><a href="../interfaces/INameMatch.html" target="_self" >INameMatch</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                    <td>
                                        <p>filters</p>

                                    </td>
                                </tr>
                                <tr>
                                    <td>options</td>
                                    <td>
                                                <code><a href="../entitys/User.html" target="_self" >IFindOptions&lt;User&gt;</a></code>
                                    </td>

                                    <td>
                                        Yes
                                    </td>


                                    <td>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../interfaces/User.html" target="_self" >Promise&lt;Counted&lt;User[]&gt;&gt;</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="removeMatch"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>removeMatch</b></span>
                        <a href="#removeMatch"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>removeMatch(currentUserId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>, importUserId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="85"
                            class="link-to-prism">apps/server/src/modules/user-import/uc/user-import.uc.ts:85</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>currentUserId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>importUserId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="saveAllUsersMatches"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>saveAllUsersMatches</b></span>
                        <a href="#saveAllUsersMatches"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>saveAllUsersMatches(currentUserId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="143"
                            class="link-to-prism">apps/server/src/modules/user-import/uc/user-import.uc.ts:143</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>currentUserId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="setMatch"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>setMatch</b></span>
                        <a href="#setMatch"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>setMatch(currentUserId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>, importUserId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>, userMatchId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="58"
                            class="link-to-prism">apps/server/src/modules/user-import/uc/user-import.uc.ts:58</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Update a @User reference of an @ImportUser</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>currentUserId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>importUserId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>userMatchId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        <p>importuser and matched user</p>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateFlag"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>updateFlag</b></span>
                        <a href="#updateFlag"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateFlag(currentUserId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>, importUserId: <a href="../undefineds/EntityId.html" target="_self">EntityId</a>, flagged: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank">boolean</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="102"
                            class="link-to-prism">apps/server/src/modules/user-import/uc/user-import.uc.ts:102</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>currentUserId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>importUserId</td>
                                    <td>
                                                <code><a href="../miscellaneous/typealiases.html#EntityId" target="_self" >EntityId</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>flagged</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateUserAndAccount"></a>
                    <span class="name">
                        <span class="modifier">Private</span>
                        <span class="modifier">Async</span>
                        <span ><b>updateUserAndAccount</b></span>
                        <a href="#updateUserAndAccount"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updateUserAndAccount(importUser: <a href="../interfaces/User.html" target="_self">ImportUser</a>, school: <a href="../entitys/School.html" target="_self">School</a>)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="169"
                            class="link-to-prism">apps/server/src/modules/user-import/uc/user-import.uc.ts:169</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>importUser</td>
                                    <td>
                                                <code><a href="../interfaces/User.html" target="_self" >ImportUser</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>school</td>
                                    <td>
                                                <code><a href="../entitys/School.html" target="_self" >School</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { ForbiddenException, Injectable } from &#x27;@nestjs/common&#x27;;
import { UserAlreadyAssignedToImportUserError } from &#x27;@shared/common&#x27;;
import {
	Counted,
	EntityId,
	IFindOptions,
	IImportUserScope,
	ImportUser,
	INameMatch,
	MatchCreator,
	MatchCreatorScope,
	PermissionService,
	School,
	User,
} from &#x27;@shared/domain&#x27;;

import { ImportUserRepo, SchoolRepo, UserRepo, AccountRepo } from &#x27;@shared/repo&#x27;;
import { UserImportPermissions } from &#x27;../constants&#x27;;

@Injectable()
export class UserImportUc {
	constructor(
		private readonly accountRepo: AccountRepo,
		private readonly importUserRepo: ImportUserRepo,
		private readonly permissionService: PermissionService,
		private readonly schoolRepo: SchoolRepo,
		private readonly userRepo: UserRepo
	) {}

	/**
	 * Resolves with current users schools importusers and matched users.
	 * @param userId
	 * @param query
	 * @param options
	 * @returns
	 */
	async findAllImportUsers(
		userId: EntityId,
		query: IImportUserScope,
		options?: IFindOptions&lt;ImportUser&gt;
	): Promise&lt;Counted&lt;ImportUser[]&gt;&gt; {
		const currentUser &#x3D; await this.userRepo.findById(userId, true);

		const permissions &#x3D; [UserImportPermissions.SCHOOL_IMPORT_USERS_VIEW];
		this.permissionService.checkUserHasAllSchoolPermissions(currentUser, permissions);

		const countedImportUsers &#x3D; await this.importUserRepo.findImportUsers(currentUser.school, query, options);
		return countedImportUsers;
	}

	/**
	 * Update a @User reference of an @ImportUser
	 * @param currentUserId
	 * @param importUserId
	 * @param userMatchId
	 * @returns importuser and matched user
	 */
	async setMatch(currentUserId: EntityId, importUserId: EntityId, userMatchId: EntityId) {
		const currentUser &#x3D; await this.userRepo.findById(currentUserId, true);
		const permissions &#x3D; [UserImportPermissions.SCHOOL_IMPORT_USERS_UPDATE];
		this.permissionService.checkUserHasAllSchoolPermissions(currentUser, permissions);

		const userMatch &#x3D; await this.userRepo.findById(userMatchId, true);
		const importUser &#x3D; await this.importUserRepo.findById(importUserId);

		// check same school
		if (
			!currentUser.school.id ||
			currentUser.school.id !&#x3D;&#x3D; userMatch.school.id ||
			currentUser.school.id !&#x3D;&#x3D; importUser.school.id
		) {
			throw new ForbiddenException(&#x27;not same school&#x27;);
		}

		// check user is not already assigned
		const hasMatch &#x3D; await this.importUserRepo.hasMatch(userMatch);
		if (hasMatch !&#x3D;&#x3D; null) throw new UserAlreadyAssignedToImportUserError();

		importUser.setMatch(userMatch, MatchCreator.MANUAL);
		await this.importUserRepo.persistAndFlush(importUser);

		return importUser;
	}

	async removeMatch(currentUserId: EntityId, importUserId: EntityId) {
		const currentUser &#x3D; await this.userRepo.findById(currentUserId, true);
		const permissions &#x3D; [UserImportPermissions.SCHOOL_IMPORT_USERS_UPDATE];
		this.permissionService.checkUserHasAllSchoolPermissions(currentUser, permissions);

		const importUser &#x3D; await this.importUserRepo.findById(importUserId);
		// check same school
		if (currentUser.school.id !&#x3D;&#x3D; importUser.school.id) {
			throw new ForbiddenException(&#x27;not same school&#x27;);
		}

		importUser.revokeMatch();
		await this.importUserRepo.persistAndFlush(importUser);

		return importUser;
	}

	async updateFlag(currentUserId: EntityId, importUserId: EntityId, flagged: boolean) {
		const currentUser &#x3D; await this.userRepo.findById(currentUserId, true);
		const permissions &#x3D; [UserImportPermissions.SCHOOL_IMPORT_USERS_UPDATE];
		this.permissionService.checkUserHasAllSchoolPermissions(currentUser, permissions);

		const importUser &#x3D; await this.importUserRepo.findById(importUserId);

		// check same school
		if (currentUser.school.id !&#x3D;&#x3D; importUser.school.id) {
			throw new ForbiddenException(&#x27;not same school&#x27;);
		}

		importUser.flagged &#x3D; flagged &#x3D;&#x3D;&#x3D; true;
		await this.importUserRepo.persistAndFlush(importUser);

		return importUser;
	}

	/**
	 * Returns a list of users wich is not assigned as match to importusers.
	 * The result will filter by curernt users school by default.
	 * The current user must have permission to read schools users and view importusers.
	 * @param currentUserId
	 * @param query filters
	 * @param options
	 * @returns
	 */
	async findAllUnmatchedUsers(
		currentUserId: EntityId,
		query: INameMatch,
		options?: IFindOptions&lt;User&gt;
	): Promise&lt;Counted&lt;User[]&gt;&gt; {
		const currentUser &#x3D; await this.userRepo.findById(currentUserId, true);

		const permissions &#x3D; [UserImportPermissions.SCHOOL_IMPORT_USERS_VIEW];
		this.permissionService.checkUserHasAllSchoolPermissions(currentUser, permissions);

		const unmatchedCountedUsers &#x3D; await this.userRepo.findWithoutImportUser(currentUser.school, query, options);
		return unmatchedCountedUsers;
	}

	async saveAllUsersMatches(currentUserId: EntityId): Promise&lt;void&gt; {
		const currentUser &#x3D; await this.userRepo.findById(currentUserId, true);

		const permissions &#x3D; [UserImportPermissions.SCHOOL_IMPORT_USERS_MIGRATE];
		this.permissionService.checkUserHasAllSchoolPermissions(currentUser, permissions);

		const { school } &#x3D; currentUser;

		const filters: IImportUserScope &#x3D; { matches: [MatchCreatorScope.MANUAL, MatchCreatorScope.AUTO] };
		// TODO batch/paginated import?
		const options: IFindOptions&lt;ImportUser&gt; &#x3D; {};
		const [importUsers, total] &#x3D; await this.importUserRepo.findImportUsers(school, filters, options);
		if (total &gt; 0) {
			importUsers.map(async (importUser) &#x3D;&gt; {
				await this.updateUserAndAccount(importUser, school);
			});
			await this.userRepo.flush();
			await this.accountRepo.flush();
		}

		await this.importUserRepo.deleteImportUsersBySchool(school);

		school.inUserMigration &#x3D; false;
		await this.schoolRepo.persistAndFlush(school);
	}

	private async updateUserAndAccount(importUser: ImportUser, school: School) {
		if (!importUser.user || !importUser.loginName || !school.ldapSchoolIdentifier) {
			return;
		}
		importUser.user.ldapId &#x3D; importUser.ldapId;
		this.userRepo.persist(importUser.user);

		const account &#x3D; await this.accountRepo.findOneByUser(importUser.user);
		account.systemId &#x3D; importUser.system._id;
		account.password &#x3D; undefined;
		account.username &#x3D; &#x60;${school.ldapSchoolIdentifier}/${importUser.loginName}&#x60;;
		this.accountRepo.persist(account);
	}
}
</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'UserImportUc.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
